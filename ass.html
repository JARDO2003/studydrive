<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyDrive - Plateforme Acad√©mique Professionnelle</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-light: #60a5fa;
            --primary-dark: #1e40af;
            --accent: #f59e0b;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --dark-lighter: #334155;
            --white: #ffffff;
            --gray: #94a3b8;
            --gray-light: #f1f5f9;
            --success: #10b981;
            --danger: #ef4444;
            --shadow: rgba(37, 99, 235, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gray-light);
            color: var(--dark);
            overflow-x: hidden;
        }

        /* INTRO SECTION */
        #introSection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 10000;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .intro-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 50%, rgba(96, 165, 250, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(37, 99, 235, 0.1) 0%, transparent 50%);
        }

        .intro-content {
            text-align: center;
            z-index: 2;
            animation: fadeInUp 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .intro-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 30px;
            background: var(--white);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .intro-title {
            font-size: 56px;
            font-weight: 900;
            color: var(--white);
            margin-bottom: 15px;
            letter-spacing: -2px;
        }

        .intro-subtitle {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
            margin-bottom: 50px;
        }

        .intro-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
        }

        .intro-progress-bar {
            height: 100%;
            background: var(--white);
            width: 0%;
            animation: loading 2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes loading {
            to { width: 100%; }
        }

        /* REGISTRATION */
        #registrationOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--gray-light);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9000;
            padding: 20px;
        }

        .registration-box {
            background: var(--white);
            padding: 50px;
            border-radius: 16px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .registration-logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            margin: 0 auto 25px;
        }

        .registration-title {
            font-size: 32px;
            font-weight: 800;
            color: var(--dark);
            text-align: center;
            margin-bottom: 10px;
        }

        .registration-subtitle {
            text-align: center;
            color: var(--gray);
            margin-bottom: 35px;
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--gray-light);
            border: 2px solid transparent;
            color: var(--dark);
            font-size: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* MAIN APP */
        #mainApp {
            display: none;
            min-height: 100vh;
            background: var(--gray-light);
        }

        /* NAVBAR */
        .navbar {
            background: var(--white);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .logo-text h1 {
            font-size: 22px;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .logo-text p {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
        }

        .navbar-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: var(--gray);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--gray-light);
            padding: 8px 16px;
            border-radius: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .user-info h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
        }

        .user-info p {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
        }

        /* SEARCH BAR */
        .search-section {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .search-container {
            position: relative;
            max-width: 700px;
            margin: 0 auto;
        }

        .search-box {
            background: var(--white);
            border: 2px solid transparent;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .search-box:focus-within {
            border-color: var(--primary);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .search-icon {
            font-size: 20px;
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--dark);
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            outline: none;
        }

        .search-input::placeholder {
            color: var(--gray);
            font-weight: 400;
        }

        .search-clear {
            background: var(--gray-light);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--gray);
            transition: all 0.3s ease;
        }

        .search-clear:hover {
            background: var(--primary);
            color: var(--white);
        }

        .search-clear.active {
            display: flex;
        }

        /* SEARCH SUGGESTIONS */
        .search-suggestions {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 12px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestions-header {
            padding: 18px 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestions-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--dark);
        }

        .suggestions-count {
            font-size: 12px;
            color: var(--gray);
            font-weight: 600;
        }

        .suggestion-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .suggestion-item:hover {
            background: var(--gray-light);
        }

        .suggestion-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }

        .suggestion-info {
            flex: 1;
        }

        .suggestion-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .suggestion-highlight {
            background: rgba(37, 99, 235, 0.15);
            color: var(--primary);
            padding: 0 2px;
        }

        .suggestion-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
        }

        .suggestion-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            border-radius: 5px;
        }

        .no-results {
            padding: 50px 20px;
            text-align: center;
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .no-results-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .no-results-hint {
            font-size: 13px;
            color: var(--gray);
        }

        .search-shortcuts {
            padding: 15px 20px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .shortcut-chip {
            padding: 6px 12px;
            background: var(--gray-light);
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shortcut-chip:hover {
            background: var(--primary);
            color: var(--white);
        }

        /* CONTROLS */
        .controls-section {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .section-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--dark);
        }

        .filter-btn {
            padding: 10px 20px;
            background: var(--white);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--gray);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--white);
        }

        .publish-btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .publish-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px var(--shadow);
        }

        /* SUBJECTS GRID */
        .subjects-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px 60px;
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .subject-card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.4s ease;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .subject-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .subject-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            transition: all 0.4s ease;
        }

        .subject-card:hover .subject-image {
            transform: scale(1.05);
        }

        .subject-content {
            padding: 25px;
        }

        .subject-header {
            margin-bottom: 15px;
        }

        .subject-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .subject-badge {
            display: inline-block;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 700;
            border-radius: 6px;
        }

        .badge-iter { 
            color: #6366f1; 
            background: rgba(99, 102, 241, 0.1);
        }
        .badge-gcv { 
            color: #10b981; 
            background: rgba(16, 185, 129, 0.1);
        }
        .badge-seg { 
            color: #f59e0b; 
            background: rgba(245, 158, 11, 0.1);
        }
        .badge-icrh { 
            color: #ec4899; 
            background: rgba(236, 72, 153, 0.1);
        }

        .subject-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            color: var(--gray);
            font-size: 13px;
            font-weight: 600;
        }

        .subject-divider {
            width: 100%;
            height: 1px;
            background: var(--gray-light);
            margin: 18px 0;
        }

        .subject-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .author-avatar {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
        }

        .author-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
        }

        .author-time {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
        }

        /* IMAGE FULLSCREEN MODAL */
        .image-fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .fullscreen-content {
            position: relative;
            max-width: 95%;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fullscreen-image {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .fullscreen-controls {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .fullscreen-btn {
            padding: 12px 24px;
            background: var(--white);
            color: var(--dark);
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fullscreen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
        }

        .fullscreen-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: var(--white);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: var(--dark);
            transition: all 0.3s ease;
        }

        .fullscreen-close:hover {
            background: var(--primary);
            color: var(--white);
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 5000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--white);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 28px;
            font-weight: 800;
            color: var(--dark);
        }

        .close-btn {
            background: var(--gray-light);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 22px;
            color: var(--gray);
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--primary);
            color: var(--white);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: block;
            width: 100%;
        }

        .file-input-btn {
            background: var(--gray-light);
            border: 2px dashed var(--gray);
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-btn:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .image-preview {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 80px;
            color: var(--gray);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* FOCUS CLASS SECTION */
        .focus-class-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--dark);
            z-index: 8000;
            display: none;
            flex-direction: column;
        }

        .focus-class-header {
            background: var(--dark-light);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--dark-lighter);
        }

        .focus-class-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .focus-class-title h2 {
            font-size: 24px;
            font-weight: 800;
            color: var(--white);
        }

        .focus-badge {
            padding: 6px 12px;
            background: var(--success);
            color: var(--white);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .focus-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--white);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .focus-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .focus-btn {
            padding: 10px 20px;
            background: var(--dark-lighter);
            border: none;
            border-radius: 10px;
            color: var(--white);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .focus-btn:hover {
            background: var(--primary);
        }

        .focus-btn.danger {
            background: var(--danger);
        }

        .focus-btn.danger:hover {
            background: #dc2626;
        }

        .focus-class-content {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 0;
            overflow: hidden;
        }

        .subject-panel {
            background: var(--dark-light);
            padding: 25px;
            overflow-y: auto;
            border-right: 1px solid var(--dark-lighter);
        }

        .subject-panel h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subject-display {
            background: var(--dark-lighter);
            border-radius: 12px;
            overflow: hidden;
        }

        .subject-display img {
            width: 100%;
            height: auto;
            display: block;
            cursor: zoom-in;
        }

        .subject-info{
            padding: 15px;
        }

        .subject-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 8px;
        }

        .subject-info p {
            font-size: 12px;
            color: var(--gray);
            line-height: 1.6;
        }

        .upload-subject-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .upload-subject-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .video-grid {
            background: var(--dark);
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            align-content: start;
            overflow-y: auto;
        }

        .video-container {
            background: var(--dark-lighter);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 4/3;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-container.local {
            border: 3px solid var(--primary);
        }

        .video-label {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 12px;
            border-radius: 8px;
            color: var(--white);
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .video-muted {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(239, 68, 68, 0.9);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--white);
            font-size: 18px;
        }

        .no-video {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray);
        }

        .no-video-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .no-video-text {
            font-size: 14px;
            font-weight: 600;
        }

        .participants-panel {
            background: var(--dark-light);
            border-left: 1px solid var(--dark-lighter);
            display: flex;
            flex-direction: column;
        }

        .participants-header {
            padding: 20px;
            border-bottom: 1px solid var(--dark-lighter);
        }

        .participants-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .participants-count {
            background: var(--primary);
            color: var(--white);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 12px;
        }

        .participants-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .participant-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--dark-lighter);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--white);
        }

        .participant-status {
            font-size: 11px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        .media-controls {
            background: var(--dark-light);
            padding: 20px 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            border-top: 1px solid var(--dark-lighter);
        }

        .media-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            background: var(--dark-lighter);
            color: var(--white);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .media-btn.active {
            background: var(--primary);
        }

        .media-btn.danger {
            background: var(--danger);
        }

        .media-btn.danger:hover {
            background: #dc2626;
        }

        .subject-upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .subject-upload-content {
            background: var(--white);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            border-radius: 16px;
        }

        .subject-upload-content h3 {
            font-size: 24px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 25px;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .focus-class-content {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 968px) {
            .focus-class-content {
                grid-template-columns: 1fr;
            }
            
            .subject-panel,
            .participants-panel {
                display: none;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .navbar-content {
                flex-direction: column;
                gap: 15px;
            }

            .navbar-menu {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .user-badge {
                width: 100%;
                justify-content: center;
            }

            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-wrap: wrap;
            }

            .filter-btn {
                flex: 1;
                min-width: calc(50% - 5px);
            }

            .publish-btn {
                width: 100%;
            }

            .subjects-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 30px 20px;
            }

            .registration-box {
                padding: 40px 25px;
            }

            .intro-title {
                font-size: 42px;
            }
        }
    </style>
</head>
<body>
    <!-- INTRO SECTION -->
    <div id="introSection">
        <div class="intro-background"></div>
        <div class="intro-content">
            <div class="intro-logo">üéì</div>
            <h1 class="intro-title">StudyDrive</h1>
            <p class="intro-subtitle">Plateforme Acad√©mique Professionnelle</p>
            <div class="intro-progress">
                <div class="intro-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- REGISTRATION -->
    <div id="registrationOverlay">
        <div class="registration-box">
            <div class="registration-logo">üéì</div>
            <h2 class="registration-title">Bienvenue</h2>
            <p class="registration-subtitle">Cr√©ez votre compte pour commencer</p>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="nom">Nom</label>
                    <input type="text" id="nom" required placeholder="Votre nom">
                </div>
                <div class="form-group">
                    <label for="prenom">Pr√©nom</label>
                    <input type="text" id="prenom" required placeholder="Votre pr√©nom">
                </div>
                <div class="form-group">
                    <label for="filiere">Fili√®re</label>
                    <select id="filiere" required>
                        <option value="">S√©lectionnez votre fili√®re</option>
                        <option value="ITER">ITER</option>
                        <option value="GCV">GCV</option>
                        <option value="SEG">SEG</option>
                        <option value="ICRH">ICRH</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contact">Contact</label>
                    <input type="text" id="contact" required placeholder="email@exemple.com">
                </div>
                <button type="submit" class="submit-btn">Commencer</button>
            </form>
        </div>
    </div>
    
    <!-- MAIN APP -->
    <div id="mainApp">
        <!-- NAVBAR -->
        <nav class="navbar">
            <div class="navbar-content">
                <div class="logo-container">
                    <div class="logo-icon">üéì</div>
                    <div class="logo-text">
                        <h1>StudyDrive</h1>
                        <p>Excellence</p>
                    </div>
                </div>
                <div class="navbar-menu">
                    <a href="#" class="nav-link">Accueil</a>
                    <a href="apropos.html" class="nav-link">√Ä Propos</a>
                    <a class="nav-link" onclick="app.focusClass.initialize()">üéØ FocusClass</a>
                    <a href="#" class="nav-link">Ressources</a>
                    <div class="user-badge">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-info">
                            <h3 id="userName">Utilisateur</h3>
                            <p id="userFiliere">Fili√®re</p>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- SEARCH BAR -->
        <div class="search-section">
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input 
                        type="text" 
                        class="search-input" 
                        id="searchInput"
                        placeholder="Rechercher un sujet, une mati√®re, une ann√©e..."
                        autocomplete="off"
                    >
                    <button class="search-clear" id="searchClear" onclick="app.search.clear()">√ó</button>
                </div>
                
                <div class="search-suggestions" id="searchSuggestions">
                    <div class="suggestions-header">
                        <span class="suggestions-title">R√©sultats</span>
                        <span class="suggestions-count" id="suggestionsCount">0 trouv√©(s)</span>
                    </div>
                    <div id="suggestionsList"></div>
                    <div class="search-shortcuts">
                        <span style="font-size: 11px; color: var(--gray); font-weight: 600;">RECHERCHES RAPIDES:</span>
                        <button class="shortcut-chip" onclick="app.search.quick('2024')">2024</button>
                        <button class="shortcut-chip" onclick="app.search.quick('2023')">2023</button>
                        <button class="shortcut-chip" onclick="app.search.quick('ITER')">ITER</button>
                        <button class="shortcut-chip" onclick="app.search.quick('GCV')">GCV</button>
                        <button class="shortcut-chip" onclick="app.search.quick('SEG')">SEG</button>
                        <button class="shortcut-chip" onclick="app.search.quick('ICRH')">ICRH</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="controls-section">
            <div style="display: flex; align-items: center; gap: 30px; flex-wrap: wrap;">
                <h2 class="section-title">Collection</h2>
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="all">Tous</button>
                    <button class="filter-btn" data-filter="ITER">ITER</button>
                    <button class="filter-btn" data-filter="GCV">GCV</button>
                    <button class="filter-btn" data-filter="SEG">SEG</button>
                    <button class="filter-btn" data-filter="ICRH">ICRH</button>
                </div>
            </div>
            <button class="publish-btn" onclick="app.modal.openPublish()">+ Publier</button>
        </div>

        <!-- SUBJECTS -->
        <div class="subjects-container">
            <div class="subjects-grid" id="subjectsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Chargement...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PUBLISH MODAL -->
    <div id="publishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nouveau Sujet</h2>
                <button class="close-btn" onclick="app.modal.closePublish()">√ó</button>
            </div>
            <form id="publishForm">
                <div class="form-group">
                    <label for="subjectTitle">Titre</label>
                    <input type="text" id="subjectTitle" required placeholder="Titre du sujet">
                </div>
                <div class="form-group">
                    <label for="subjectFiliere">Fili√®re</label>
                    <select id="subjectFiliere" required>
                        <option value="">S√©lectionnez</option>
                        <option value="ITER">ITER</option>
                        <option value="GCV">GCV</option>
                        <option value="SEG">SEG</option>
                        <option value="ICRH">ICRH</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subjectYear">Ann√©e</label>
                    <select id="subjectYear" required></select>
                </div>
                <div class="form-group">
                    <label>Image</label>
                    <div class="file-input-wrapper">
                        <label for="subjectImage" class="file-input-btn">
                            <div style="font-size: 50px; margin-bottom: 15px;">üì∏</div>
                            <div style="font-weight: 700; color: var(--primary); letter-spacing: 2px;">S√âLECTIONNER</div>
                            <div style="font-size: 11px; color: var(--gray); margin-top: 10px; text-transform: uppercase; letter-spacing: 1px;">PNG, JPG jusqu'√† 10MB</div>
                        </label>
                        <input type="file" id="subjectImage" accept="image/*" required>
                    </div>
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                <div class="form-group">
                    <label for="subjectDescription">Description</label>
                    <textarea id="subjectDescription" placeholder="D√©tails optionnels..." style="min-height: 120px; resize: vertical;"></textarea>
                </div>
                <button type="submit" class="submit-btn">Publier</button>
            </form>
        </div>
    </div>

    <!-- IMAGE FULLSCREEN MODAL -->
    <div id="imageFullscreenModal" class="image-fullscreen-modal">
        <div class="fullscreen-content">
            <button class="fullscreen-close" onclick="app.modal.closeFullscreen()">√ó</button>
            <img id="fullscreenImage" class="fullscreen-image" src="" alt="Image en plein √©cran">
            <div class="fullscreen-controls">
                <button class="fullscreen-btn" onclick="app.modal.downloadImage()">
                    <span>üì•</span> T√©l√©charger HD
                </button>
                <button class="fullscreen-btn" onclick="app.modal.closeFullscreen()">
                    <span>‚úï</span> Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- FOCUS CLASS SECTION -->
    <div id="focusClassSection" class="focus-class-section">
        <div class="focus-class-header">
            <div class="focus-class-title">
                <h2>üéØ FocusClass</h2>
                <div class="focus-badge">
                    <span>LIVE</span>
                </div>
            </div>
            <div class="focus-controls">
                <button class="focus-btn" onclick="app.focusClass.showPermissionsHelp()">
                    <span>‚ùì</span> Aide
                </button>
                <button class="focus-btn" onclick="app.focusClass.copyRoomLink()">
                    <span>üîó</span> Copier lien
                </button>
                <button class="focus-btn danger" onclick="app.focusClass.leave()">
                    <span>üëã</span> Quitter
                </button>
            </div>
        </div>

        <div class="focus-class-content">
            <!-- SUBJECT PANEL -->
            <div class="subject-panel">
                <h3>üìö Sujet d'√©tude</h3>
                <div class="subject-display" id="focusSubjectDisplay">
                    <div style="padding: 40px; text-align: center; color: var(--gray);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì∏</div>
                        <p style="font-size: 13px;">Aucun sujet ajout√©</p>
                    </div>
                </div>
                <button class="upload-subject-btn" onclick="app.modal.openSubjectUpload()">
                    üì§ Ajouter un sujet
                </button>
            </div>

            <!-- VIDEO GRID -->
            <div class="video-grid" id="videoGrid">
                <div class="video-container local">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="video-label">
                        <span>üìπ</span>
                        <span id="localVideoLabel">Vous</span>
                    </div>
                </div>
            </div>

            <!-- PARTICIPANTS PANEL -->
            <div class="participants-panel">
                <div class="participants-header">
                    <h3>
                        üë• Participants
                        <span class="participants-count" id="participantsCount">1</span>
                    </h3>
                </div>
                <div class="participants-list" id="participantsList"></div>
            </div>
        </div>

        <div class="media-controls">
            <button class="media-btn active" id="toggleVideoBtn" onclick="app.focusClass.toggleVideo()">
                <span id="videoIcon">üìπ</span>
            </button>
            <button class="media-btn active" id="toggleAudioBtn" onclick="app.focusClass.toggleAudio()">
                <span id="audioIcon">üé§</span>
            </button>
            <button class="media-btn" onclick="app.focusClass.switchCamera()">
                <span>üîÑ</span>
            </button>
            <button class="media-btn danger" onclick="app.focusClass.leave()">
                <span>üìû</span>
            </button>
        </div>
    </div>

    <!-- SUBJECT UPLOAD MODAL -->
    <div id="subjectUploadModal" class="subject-upload-modal">
        <div class="subject-upload-content">
            <h3>üìö Ajouter un sujet</h3>
            <form id="subjectUploadForm">
                <div class="form-group">
                    <label>S√©lectionner une image</label>
                    <div class="file-input-wrapper">
                        <label for="focusSubjectImage" class="file-input-btn">
                            <div style="font-size: 50px; margin-bottom: 15px;">üì∏</div>
                            <div style="font-weight: 700; color: var(--primary); letter-spacing: 2px;">S√âLECTIONNER</div>
                            <div style="font-size: 11px; color: var(--gray); margin-top: 10px;">PNG, JPG jusqu'√† 10MB</div>
                        </label>
                        <input type="file" id="focusSubjectImage" accept="image/*" required>
                    </div>
                    <div id="focusImagePreview" class="image-preview"></div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="submit-btn" style="background: var(--gray);" onclick="app.modal.closeSubjectUpload()">
                        Annuler
                    </button>
                    <button type="submit" class="submit-btn">
                        Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            addDoc, 
            getDocs, 
            query, 
            orderBy, 
            serverTimestamp,
            onSnapshot,
            deleteDoc
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCPGgtXoDUycykLaTSee0S0yY0tkeJpqKI",
            authDomain: "data-com-a94a8.firebaseapp.com",
            databaseURL: "https://data-com-a94a8-default-rtdb.firebaseio.com",
            projectId: "data-com-a94a8",
            storageBucket: "data-com-a94a8.appspot.com",
            messagingSenderId: "276904640935",
            appId: "1:276904640935:web:9cd805aeba6c34c767f682"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);

        const cloudinaryConfig = {
            cloudName: 'djxcqczh1',
            uploadPreset: 'database'
        };

        // Demander les permissions t√¥t
        async function requestPermissionsEarly() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                sessionStorage.setItem('mediaPermissionsGranted', 'true');
                stream.getTracks().forEach(track => track.stop());
                console.log('‚úÖ Permissions pr√©-accord√©es');
                return true;
            } catch (error) {
                console.warn('Permissions non accord√©es:', error);
                sessionStorage.setItem('mediaPermissionsGranted', 'false');
                return false;
            }
        }

        window.addEventListener('load', requestPermissionsEarly);

        const app = {
            userData: null,
            subjectsData: [],
            currentFilter: 'all',
            searchTimeout: null,
            currentImageUrl: '',

            auth: {
                init() {
                    setTimeout(() => {
                        const intro = document.getElementById('introSection');
                        intro.style.transition = 'opacity 1.5s ease, transform 1.5s ease';
                        intro.style.opacity = '0';
                        intro.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            intro.style.display = 'none';
                            app.auth.checkUser();
                        }, 1500);
                    }, 3000);
                },

                checkUser() {
                    const sessionData = sessionStorage.getItem('studydriveUser');
                    const localData = localStorage.getItem('studydriveUser');
                    const dataToUse = sessionData || localData;
                    
                    if (dataToUse) {
                        app.userData = JSON.parse(dataToUse);
                        document.getElementById('registrationOverlay').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('userName').textContent = app.userData.fullName;
                        document.getElementById('userAvatar').textContent = app.userData.avatar;
                        document.getElementById('userFiliere').textContent = app.userData.filiere;
                        app.subjects.load();
                    } else {
                        document.getElementById('registrationOverlay').style.display = 'flex';
                    }
                },

                async register(formData) {
                    try {
                        const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        
                        app.userData = {
                            id: userId,
                            ...formData,
                            fullName: `${formData.prenom} ${formData.nom}`,
                            avatar: `${formData.prenom[0].toUpperCase()}${formData.nom[0].toUpperCase()}`,
                            registeredAt: new Date().toISOString()
                        };

                        sessionStorage.setItem('studydriveUser', JSON.stringify(app.userData));
                        localStorage.setItem('studydriveUser', JSON.stringify(app.userData));

                        await setDoc(doc(db, 'studydrive_users', app.userData.id), {
                            ...app.userData,
                            createdAt: serverTimestamp()
                        });

                        document.getElementById('registrationOverlay').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        
                        document.getElementById('userName').textContent = app.userData.fullName;
                        document.getElementById('userAvatar').textContent = app.userData.avatar;
                        document.getElementById('userFiliere').textContent = app.userData.filiere;

                        app.subjects.load();
                    } catch (error) {
                        console.error('Registration error:', error);
                        throw error;
                    }
                }
            },

            subjects: {
                load() {
                    const q = query(collection(db, 'studydrive_subjects'), orderBy('timestamp', 'desc'));
                    
                    onSnapshot(q, (snapshot) => {
                        app.subjectsData = [];
                        snapshot.forEach((doc) => {
                            app.subjectsData.push({ id: doc.id, ...doc.data() });
                        });
                        app.subjects.render();
                    });
                },

                render() {
                    const grid = document.getElementById('subjectsGrid');
                    
                    const filtered = app.currentFilter === 'all' 
                        ? app.subjectsData
                        : app.subjectsData.filter(s => s.filiere === app.currentFilter);

                    if (filtered.length === 0) {
                        grid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 80px 20px;">
                                <h3 style="font-size: 32px; margin-bottom: 15px; color: var(--dark);">Collection Vide</h3>
                                <p style="color: var(--gray);">Aucun sujet disponible pour cette s√©lection</p>
                            </div>
                        `;
                        return;
                    }

                    grid.innerHTML = filtered.map(subject => {
                        const badgeClass = `badge-${subject.filiere.toLowerCase()}`;
                        return `
                            <div class="subject-card">
                                <img src="${subject.imageUrl}" alt="${subject.title}" class="subject-image" onclick="app.modal.openFullscreen('${subject.imageUrl}')" style="cursor: zoom-in;">
                                <div class="subject-content">
                                    <div class="subject-header">
                                        <div class="subject-title">${subject.title}</div>
                                        <span class="subject-badge ${badgeClass}">${subject.filiere}</span>
                                    </div>
                                    <div class="subject-meta">
                                        <span>üìÖ ${subject.year}</span>
                                        <span>üí¨ ${subject.messages?.length || 0}</span>
                                    </div>
                                    ${subject.description ? `<p style="color: var(--gray); font-size: 14px; margin-bottom: 15px; line-height: 1.6;">${subject.description}</p>` : ''}
                                    <div class="subject-divider"></div>
                                    <div class="subject-author">
                                        <div class="author-avatar">${subject.authorAvatar}</div>
                                        <div style="flex: 1;">
                                            <div class="author-name">${subject.authorName}</div>
                                            <div class="author-time">${app.utils.formatTime(subject.timestamp)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                },

                async create(formData) {
                    try {
                        await addDoc(collection(db, 'studydrive_subjects'), {
                            ...formData,
                            authorId: app.userData.id,
                            authorName: app.userData.fullName,
                            authorAvatar: app.userData.avatar,
                            authorContact: app.userData.contact,
                            messages: [],
                            timestamp: serverTimestamp()
                        });
                    } catch (error) {
                        console.error('Error creating subject:', error);
                        throw error;
                    }
                }
            },

            search: {
                clear() {
                    document.getElementById('searchInput').value = '';
                    document.getElementById('searchClear').classList.remove('active');
                    document.getElementById('searchSuggestions').classList.remove('active');
                    app.subjects.render();
                },

                quick(term) {
                    document.getElementById('searchInput').value = term;
                    this.perform(term);
                },

                perform(query) {
                    const searchTerm = query.toLowerCase().trim();
                    
                    if (searchTerm === '') {
                        document.getElementById('searchSuggestions').classList.remove('active');
                        document.getElementById('searchClear').classList.remove('active');
                        return;
                    }

                    document.getElementById('searchClear').classList.add('active');

                    const results = app.subjectsData.filter(subject => {
                        return subject.title.toLowerCase().includes(searchTerm) ||
                               subject.filiere.toLowerCase().includes(searchTerm) ||
                               subject.year.toString().includes(searchTerm) ||
                               (subject.description && subject.description.toLowerCase().includes(searchTerm)) ||
                               subject.authorName.toLowerCase().includes(searchTerm);
                    });

                    this.displaySuggestions(results, searchTerm);
                },

                displaySuggestions(results, searchTerm) {
                    const list = document.getElementById('suggestionsList');
                    const count = document.getElementById('suggestionsCount');
                    const container = document.getElementById('searchSuggestions');

                    count.textContent = `${results.length} trouv√©(s)`;
                    container.classList.add('active');

                    if (results.length === 0) {
                        list.innerHTML = `
                            <div class="no-results">
                                <div class="no-results-icon">üîç</div>
                                <div class="no-results-text">Aucun r√©sultat trouv√©</div>
                                <div class="no-results-hint">Essayez avec d'autres mots-cl√©s</div>
                            </div>
                        `;
                        return;
                    }

                    list.innerHTML = results.map(subject => {
                        const badgeClass = `badge-${subject.filiere.toLowerCase()}`;
                        const highlightedTitle = this.highlightText(subject.title, searchTerm);
                        
                        return `
                            <div class="suggestion-item" onclick="app.modal.openFullscreen('${subject.imageUrl}')">
                                <img src="${subject.imageUrl}" alt="${subject.title}" class="suggestion-icon">
                                <div class="suggestion-info">
                                    <div class="suggestion-title">${highlightedTitle}</div>
                                    <div class="suggestion-meta">
                                        <span class="suggestion-badge ${badgeClass}">${subject.filiere}</span>
                                        <span>üìÖ ${subject.year}</span>
                                        <span>üë§ ${subject.authorName}</span>
                                        <span>üí¨ ${subject.messages?.length || 0}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                },

                highlightText(text, query) {
                    const regex = new RegExp(`(${query})`, 'gi');
                    return text.replace(regex, '<span class="suggestion-highlight">$1</span>');
                }
            },

            modal: {
                openPublish() {
                    document.getElementById('publishModal').style.display = 'flex';
                },

                closePublish() {
                    document.getElementById('publishModal').style.display = 'none';
                    document.getElementById('publishForm').reset();
                    document.getElementById('imagePreview').innerHTML = '';
                },

                openFullscreen(imageUrl) {
                    app.currentImageUrl = imageUrl;
                    document.getElementById('fullscreenImage').src = imageUrl;
                    document.getElementById('imageFullscreenModal').style.display = 'flex';
                },

                closeFullscreen() {
                    document.getElementById('imageFullscreenModal').style.display = 'none';
                    app.currentImageUrl = '';
                },

                downloadImage() {
                    if (!app.currentImageUrl) return;
                    
                    const link = document.createElement('a');
                    link.href = app.currentImageUrl;
                    link.download = `StudyDrive_${Date.now()}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                openSubjectUpload() {
                    document.getElementById('subjectUploadModal').style.display = 'flex';
                },

                closeSubjectUpload() {
                    document.getElementById('subjectUploadModal').style.display = 'none';
                    document.getElementById('subjectUploadForm').reset();
                    document.getElementById('focusImagePreview').innerHTML = '';
                }
            },

            focusClass: {
                localStream: null,
                peerConnections: new Map(),
                roomId: null,
                isVideoEnabled: true,
                isAudioEnabled: true,
                currentCamera: 'user',
                unsubscribers: [],

                async requestMediaPermissions() {
                    return new Promise((resolve) => {
                        const permissionModal = document.createElement('div');
                        permissionModal.style.cssText = `
                            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
                            background: rgba(0, 0, 0, 0.95); z-index: 11000;
                            display: flex; justify-content: center; align-items: center; padding: 20px;
                            overflow-y: auto;
                        `;
                        
                        permissionModal.innerHTML = `
                            <div style="background: var(--white); padding: 30px; max-width: 500px; width: 100%; border-radius: 16px;">
                                <div style="text-align: center; margin-bottom: 25px;">
                                    <div style="font-size: 64px; margin-bottom: 15px;">üìπüé§</div>
                                    <h2 style="font-size: 22px; font-weight: 800; color: var(--dark); margin-bottom: 10px;">
                                        Autorisation Requise
                                    </h2>
                                    <p style="color: var(--gray); font-size: 14px; line-height: 1.6;">
                                        Pour participer √† FocusClass, vous devez autoriser l'acc√®s √† votre cam√©ra et microphone.
                                    </p>
                                </div>
                                
                                <div style="background: var(--gray-light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--dark); margin-bottom: 15px;">
                                        üì± Instructions pour Android
                                    </h3>
                                    <ol style="margin: 0; padding-left: 20px; color: var(--dark); font-size: 13px; line-height: 1.8;">
                                        <li>Cliquez sur <strong>"Autoriser"</strong> ci-dessous</li>
                                        <li>Une popup appara√Ætra en haut de l'√©cran</li>
                                        <li>Cliquez sur <strong>"Autoriser"</strong> dans la popup</li>
                                        <li>Si la popup ne s'affiche pas:
                                            <ul style="margin-top: 8px;">
                                                <li>Appuyez sur l'ic√¥ne üîí dans la barre d'adresse</li>
                                                <li>Activez <strong>Cam√©ra</strong> et <strong>Microphone</strong></li>
                                                <li>Rechargez la page</li>
                                            </ul>
                                        </li>
                                    </ol>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #ffc107;">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="font-size: 20px;">‚ö†Ô∏è</span>
                                        <div style="font-size: 12px; color: #856404; line-height: 1.6;">
                                            <strong>Important:</strong> Pour des raisons de s√©curit√©, les navigateurs ne permettent pas l'acc√®s automatique √† la cam√©ra/micro. Vous devez autoriser manuellement.
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button id="cancelPermBtn" 
                                            style="flex: 1; padding: 14px; background: var(--gray-light); color: var(--dark); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px;">
                                        Annuler
                                    </button>
                                    <button id="requestPermBtn"
                                            style="flex: 2; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: var(--white); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px;">
                                        ‚úì Autoriser Cam√©ra & Micro
                                    </button>
                                </div>
                                
                                <div style="text-align: center; margin-top: 20px;">
                                    <button id="spectatorBtn" style="background: none; border: none; color: var(--gray); font-size: 13px; text-decoration: underline; cursor: pointer;">
                                        Continuer en mode spectateur (sans cam√©ra/micro)
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        document.body.appendChild(permissionModal);
                        
                        document.getElementById('cancelPermBtn').onclick = () => {
                            permissionModal.remove();
                            resolve('cancelled');
                        };
                        
                        document.getElementById('spectatorBtn').onclick = () => {
                            permissionModal.remove();
                            resolve('spectator');
                        };
                        
                        document.getElementById('requestPermBtn').onclick = async () => {
                            try {
                                const stream = await navigator.mediaDevices.getUserMedia({
                                    video: true,
                                    audio: true
                                });
                                stream.getTracks().forEach(track => track.stop());
                                permissionModal.remove();
                                resolve('granted');
                            } catch (error) {
                                alert('‚ùå Permission refus√©e.\n\nüì± Pour autoriser:\n1. Cliquez sur l\'ic√¥ne üîí dans la barre d\'adresse\n2. Activez Cam√©ra et Microphone\n3. Rechargez la page');
                                permissionModal.remove();
                                resolve('denied');
                            }
                        };
                    });
                },

                async initialize() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const paramRoomId = urlParams.get('room');
                    
                    const permissionResult = await this.requestMediaPermissions();
                    
                    if (permissionResult === 'cancelled') {
                        return;
                    }
                    
                    if (permissionResult === 'spectator') {
                        this.isVideoEnabled = false;
                        this.isAudioEnabled = false;
                    }
                    
                    if (paramRoomId) {
                        this.roomId = paramRoomId;
                        await this.join();
                    } else {
                        this.showRoomsList();
                    }
                },

                showRoomsList() {
                    const modal = document.createElement('div');
                    modal.id = 'liveRoomsModal';
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
                        background: rgba(0, 0, 0, 0.9); z-index: 10000;
                        display: flex; justify-content: center; align-items: center; padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: var(--white); padding: 40px; max-width: 600px; width: 100%; border-radius: 16px; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                                <h2 style="font-size: 28px; font-weight: 800; color: var(--dark);">üéØ Sessions Live</h2>
                                <button onclick="this.closest('#liveRoomsModal').remove()" style="background: var(--gray-light); border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 22px;">√ó</button>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                                <button onclick="app.focusClass.createRoom()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: var(--white); border: none; border-radius: 10px; font-weight: 700; cursor: pointer;">
                                    + Cr√©er une session
                                </button>
                            </div>
                            <div id="liveRoomsList" style="display: flex; flex-direction: column; gap: 15px;"></div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    this.loadRoomsList();
                },

                async loadRoomsList() {
                    const roomsRef = collection(db, 'focusclass_rooms');
                    const q = query(roomsRef, orderBy('createdAt', 'desc'));
                    
                    const unsubscribe = onSnapshot(q, async (snapshot) => {
                        const roomsList = document.getElementById('liveRoomsList');
                        if (!roomsList) return;
                        
                        const rooms = [];
                        for (const docSnapshot of snapshot.docs) {
                            const roomData = docSnapshot.data();
                            if (roomData.active) {
                                const participantsSnap = await getDocs(
                                    collection(db, `focusclass_rooms/${docSnapshot.id}/participants`)
                                );
                                rooms.push({
                                    id: docSnapshot.id,
                                    ...roomData,
                                    participantCount: participantsSnap.size
                                });
                            }
                        }
                        
                        if (rooms.length === 0) {
                            roomsList.innerHTML = `
                                <div style="text-align: center; padding: 60px 20px; color: var(--gray);">
                                    <div style="font-size: 64px; margin-bottom: 20px;">üéØ</div>
                                    <p style="font-size: 16px; font-weight: 600;">Aucune session active</p>
                                    <p style="font-size: 14px; margin-top: 8px;">Cr√©ez la premi√®re session !</p>
                                </div>
                            `;
                            return;
                        }
                        
                        roomsList.innerHTML = rooms.map(room => `
                            <div onclick="app.focusClass.joinRoom('${room.id}')" style="padding: 20px; background: var(--gray-light); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(37, 99, 235, 0.1)'" onmouseout="this.style.background='var(--gray-light)'">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: var(--white); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                        üéì
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; font-size: 16px; color: var(--dark); margin-bottom: 5px;">
                                            Session de ${room.createdByName}
                                        </div>
                                        <div style="display: flex; gap: 15px; font-size: 13px; color: var(--gray); font-weight: 600;">
                                            <span>üë• ${room.participantCount} participant(s)</span>
                                            <span style="color: var(--success); display: flex; align-items: center; gap: 5px;">
                                                <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                                                LIVE
                                            </span>
                                        </div>
                                    </div>
                                    <div style="padding: 8px 16px; background: var(--primary); color: var(--white); border-radius: 8px; font-size: 13px; font-weight: 700;">
                                        Rejoindre ‚Üí
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    });
                },

                async createRoom() {
                    try {
                        this.roomId = `room_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        
                        await setDoc(doc(db, 'focusclass_rooms', this.roomId), {
                            id: this.roomId,
                            createdBy: app.userData.id,
                            createdByName: app.userData.fullName,
                            createdAt: serverTimestamp(),
                            active: true,
                            subject: null
                        });
                        
                        const modal = document.getElementById('liveRoomsModal');
                        if (modal) modal.remove();
                        
                        await this.join();
                    } catch (error) {
                        console.error('Error creating room:', error);
                        alert('Impossible de cr√©er la session');
                    }
                },

                async joinRoom(roomId) {
                    this.roomId = roomId;
                    const modal = document.getElementById('liveRoomsModal');
                    if (modal) modal.remove();
                    await this.join();
                },

                async join() {
                    try {
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('room', this.roomId);
                        window.history.pushState({}, '', newUrl);
                        
                        document.getElementById('focusClassSection').style.display = 'flex';
                        document.getElementById('mainApp').style.display = 'none';
                        
                        try {
                            await this.initMedia();
                        } catch (mediaError) {
                            console.warn('Media initialization failed:', mediaError);
                            this.isVideoEnabled = false;
                            this.isAudioEnabled = false;
                            
                            const localVideo = document.getElementById('localVideo');
                            localVideo.style.display = 'none';
                            document.querySelector('.video-container.local').innerHTML = `
                                <div class="no-video">
                                    <div class="no-video-icon">üë§</div>
                                    <div class="no-video-text">Mode Spectateur</div>
                                    <div style="font-size: 11px; margin-top: 8px; opacity: 0.7;">Cam√©ra/micro non disponible</div>
                                </div>
                                <div class="video-label">
                                    <span>üëÅÔ∏è</span>
                                    <span id="localVideoLabel">${app.userData.fullName}</span>
                                </div>
                            `;
                        }
                        
                        await this.registerParticipant();
                        this.listenToParticipants();
                        this.listenToRoomUpdates();
                        
                        console.log('‚úÖ Joined room:', this.roomId);
                    } catch (error) {
                        console.error('Error joining room:', error);
                        alert('Impossible de rejoindre la session');
                        this.leave();
                    }
                },

                async initMedia() {
                    const mediaConfigs = [
                        { video: { facingMode: this.currentCamera, width: { ideal: 1280 }, height: { ideal: 720 } },
                          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } },
                        { video: { facingMode: this.currentCamera, width: { ideal: 640 }, height: { ideal: 480 } }, audio: true },
                        { video: { facingMode: this.currentCamera }, audio: true },
                        { video: { facingMode: this.currentCamera }, audio: false },
                        { video: false, audio: true }
                    ];
                    
                    let lastError = null;
                    
                    for (let i = 0; i < mediaConfigs.length; i++) {
                        try {
                            console.log(`Trying media config ${i + 1}/${mediaConfigs.length}...`);
                            this.localStream = await navigator.mediaDevices.getUserMedia(mediaConfigs[i]);
                            
                            const localVideo = document.getElementById('localVideo');
                            localVideo.srcObject = this.localStream;
                            document.getElementById('localVideoLabel').textContent = app.userData.fullName;
                            
                            const hasVideo = this.localStream.getVideoTracks().length > 0;
                            const hasAudio = this.localStream.getAudioTracks().length > 0;
                            
                            this.isVideoEnabled = hasVideo;
                            this.isAudioEnabled = hasAudio;
                            
                            if (!hasVideo) {
                                document.getElementById('toggleVideoBtn').classList.remove('active');
                                document.getElementById('videoIcon').textContent = 'üö´';
                            }
                            if (!hasAudio) {
                                document.getElementById('toggleAudioBtn').classList.remove('active');
                                document.getElementById('audioIcon').textContent = 'üîá';
                            }
                            
                            console.log(`‚úÖ Media initialized: Video=${hasVideo}, Audio=${hasAudio}`);
                            
                            if (!hasVideo && !hasAudio) {
                                throw new Error('No media tracks available');
                            }
                            
                            return;
                        } catch (error) {
                            console.warn(`Config ${i + 1} failed:`, error);
                            lastError = error;
                            continue;
                        }
                    }
                    
                    throw lastError || new Error('Impossible d\'acc√©der √† la cam√©ra/micro');
                },

                async registerParticipant() {
                    await setDoc(doc(db, `focusclass_rooms/${this.roomId}/participants`, app.userData.id), {
                        id: app.userData.id,
                        name: app.userData.fullName,
                        avatar: app.userData.avatar,
                        joinedAt: serverTimestamp(),
                        isVideoEnabled: this.isVideoEnabled,
                        isAudioEnabled: this.isAudioEnabled
                    });
                },

                listenToParticipants() {
                    const participantsRef = collection(db, `focusclass_rooms/${this.roomId}/participants`);
                    
                    const unsubscribe = onSnapshot(participantsRef, (snapshot) => {
                        const participants = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.id !== app.userData.id) {
                                participants.push(data);
                            }
                        });
                        
                        this.renderParticipants([
                            {
                                id: app.userData.id,
                                name: app.userData.fullName,
                                avatar: app.userData.avatar,
                                isVideoEnabled: this.isVideoEnabled,
                                isAudioEnabled: this.isAudioEnabled
                            },
                            ...participants
                        ]);
                    });
                    
                    this.unsubscribers.push(unsubscribe);
                },

                renderParticipants(participants) {
                    document.getElementById('participantsCount').textContent = participants.length;
                    
                    const list = document.getElementById('participantsList');
                    list.innerHTML = participants.map(p => `
                        <div class="participant-item">
                            <div class="participant-avatar">${p.avatar}</div>
                            <div class="participant-info">
                                <div class="participant-name">${p.name}</div>
                                <div class="participant-status">
                                    <span class="status-indicator"></span>
                                    Connect√©
                                </div>
                            </div>
                        </div>
                    `).join('');
                },

                listenToRoomUpdates() {
                    const roomRef = doc(db, 'focusclass_rooms', this.roomId);
                    
                    const unsubscribe = onSnapshot(roomRef, (snapshot) => {
                        const data = snapshot.data();
                        if (data?.subject) {
                            this.displaySubject(data.subject);
                        }
                    });
                    
                    this.unsubscribers.push(unsubscribe);
                },

                displaySubject(subject) {
                    document.getElementById('focusSubjectDisplay').innerHTML = `
                        <img src="${subject.imageUrl}" alt="Sujet" style="width: 100%; cursor: zoom-in;" 
                             onclick="app.modal.openFullscreen('${subject.imageUrl}')">
                        <div class="subject-info">
                            <h4>Ajout√© par ${subject.uploadedBy}</h4>
                            <p>Cliquez sur l'image pour l'agrandir</p>
                        </div>
                    `;
                },

                toggleVideo() {
                    this.isVideoEnabled = !this.isVideoEnabled;
                    
                    const videoTrack = this.localStream?.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = this.isVideoEnabled;
                    }
                    
                    const btn = document.getElementById('toggleVideoBtn');
                    const icon = document.getElementById('videoIcon');
                    
                    if (this.isVideoEnabled) {
                        btn.classList.add('active');
                        icon.textContent = 'üìπ';
                    } else {
                        btn.classList.remove('active');
                        icon.textContent = 'üö´';
                    }
                },

                toggleAudio() {
                    this.isAudioEnabled = !this.isAudioEnabled;
                    
                    const audioTrack = this.localStream?.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = this.isAudioEnabled;
                    }
                    
                    const btn = document.getElementById('toggleAudioBtn');
                    const icon = document.getElementById('audioIcon');
                    
                    if (this.isAudioEnabled) {
                        btn.classList.add('active');
                        icon.textContent = 'üé§';
                    } else {
                        btn.classList.remove('active');
                        icon.textContent = 'üîá';
                    }
                },

                async switchCamera() {
                    try {
                        this.currentCamera = this.currentCamera === 'user' ? 'environment' : 'user';
                        
                        const videoTrack = this.localStream?.getVideoTracks()[0];
                        if (videoTrack) {
                            videoTrack.stop();
                            this.localStream.removeTrack(videoTrack);
                        }
                        
                        const newStream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: this.currentCamera, width: { ideal: 1280 }, height: { ideal: 720 } }
                        });
                        
                        const newVideoTrack = newStream.getVideoTracks()[0];
                        this.localStream.addTrack(newVideoTrack);
                        
                        const localVideo = document.getElementById('localVideo');
                        localVideo.srcObject = this.localStream;
                    } catch (error) {
                        console.error('Error switching camera:', error);
                        alert('Impossible de changer de cam√©ra');
                    }
                },

                showPermissionsHelp() {
                    alert(`üì± ACTIVER CAM√âRA & MICRO sur Android:\n\n1. Cliquez sur l'ic√¥ne üîí dans la barre d'adresse\n2. Cherchez "Cam√©ra" et "Microphone"\n3. Changez de "Bloqu√©" √† "Autoriser"\n4. Rechargez la page\n\n‚úì Les permissions seront m√©moris√©es pour les prochaines fois!`);
},
            copyRoomLink() {
                const link = `${window.location.origin}${window.location.pathname}?room=${this.roomId}`;
                navigator.clipboard.writeText(link).then(() => {
                    alert('‚úÖ Lien copi√© dans le presse-papiers !');
                }).catch(() => {
                    alert('‚ùå Impossible de copier le lien');
                });
            },

            async leave() {
                try {
                    if (this.localStream) {
                        this.localStream.getTracks().forEach(track => track.stop());
                    }
                    
                    this.peerConnections.forEach(pc => pc.close());
                    this.peerConnections.clear();
                    
                    if (this.roomId && app.userData) {
                        await deleteDoc(doc(db, `focusclass_rooms/${this.roomId}/participants`, app.userData.id));
                    }
                    
                    this.unsubscribers.forEach(unsubscribe => unsubscribe());
                    this.unsubscribers = [];
                    
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.delete('room');
                    window.history.pushState({}, '', newUrl);
                    
                    document.getElementById('focusClassSection').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    this.roomId = null;
                    this.localStream = null;
                } catch (error) {
                    console.error('Error leaving room:', error);
                }
            }
        },

        utils: {
            formatTime(timestamp) {
                if (!timestamp) return '√Ä l\'instant';
                
                let date;
                if (timestamp.seconds) {
                    date = new Date(timestamp.seconds * 1000);
                } else if (typeof timestamp === 'string') {
                    date = new Date(timestamp);
                } else {
                    return '√Ä l\'instant';
                }

                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return '√Ä l\'instant';
                if (diffMins < 60) return `${diffMins} min`;
                if (diffHours < 24) return `${diffHours}h`;
                if (diffDays < 7) return `${diffDays}j`;
                
                return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
            },

            async uploadToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);
                
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`,
                    { method: 'POST', body: formData }
                );
                
                const data = await response.json();
                return data.secure_url;
            }
        }
    };

    // EVENT LISTENERS
    const yearSelect = document.getElementById('subjectYear');
    const currentYear = new Date().getFullYear();
    for (let i = currentYear; i >= currentYear - 10; i--) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        yearSelect.appendChild(option);
    }

    document.getElementById('registrationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('.submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Connexion...';

        try {
            await app.auth.register({
                nom: document.getElementById('nom').value.trim(),
                prenom: document.getElementById('prenom').value.trim(),
                filiere: document.getElementById('filiere').value,
                contact: document.getElementById('contact').value.trim()
            });
        } catch (error) {
            alert('Erreur lors de l\'inscription');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Commencer';
        }
    });

    document.getElementById('publishForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('.submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Publication...';

        try {
            const imageFile = document.getElementById('subjectImage').files[0];
            const imageUrl = await app.utils.uploadToCloudinary(imageFile);

            await app.subjects.create({
                title: document.getElementById('subjectTitle').value,
                filiere: document.getElementById('subjectFiliere').value,
                year: parseInt(document.getElementById('subjectYear').value),
                description: document.getElementById('subjectDescription').value,
                imageUrl
            });

            app.modal.closePublish();
            alert('‚úÖ Sujet publi√© avec succ√®s !');
        } catch (error) {
            console.error('Error publishing:', error);
            alert('‚ùå Erreur lors de la publication');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Publier';
        }
    });

    document.getElementById('subjectUploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('.submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Upload...';

        try {
            const file = document.getElementById('focusSubjectImage').files[0];
            const imageUrl = await app.utils.uploadToCloudinary(file);
            
            await setDoc(doc(db, 'focusclass_rooms', app.focusClass.roomId), {
                subject: {
                    imageUrl,
                    uploadedBy: app.userData.fullName,
                    uploadedAt: serverTimestamp()
                }
            }, { merge: true });
            
            app.modal.closeSubjectUpload();
        } catch (error) {
            console.error('Error uploading subject:', error);
            alert('Erreur lors de l\'upload');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Ajouter';
        }
    });

    document.getElementById('subjectImage').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('focusSubjectImage').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('focusImagePreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(app.searchTimeout);
        app.searchTimeout = setTimeout(() => {
            app.search.perform(e.target.value);
        }, 300);
    });

    document.addEventListener('click', (e) => {
        const searchContainer = document.querySelector('.search-container');
        if (!searchContainer.contains(e.target)) {
            document.getElementById('searchSuggestions').classList.remove('active');
        }
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            app.currentFilter = this.dataset.filter;
            app.subjects.render();
        });
    });

    document.getElementById('publishModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) app.modal.closePublish();
    });

    document.getElementById('imageFullscreenModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) app.modal.closeFullscreen();
    });

    document.getElementById('subjectUploadModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) app.modal.closeSubjectUpload();
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (document.getElementById('imageFullscreenModal').style.display === 'flex') {
                app.modal.closeFullscreen();
            } else if (document.getElementById('publishModal').style.display === 'flex') {
                app.modal.closePublish();
            } else if (document.getElementById('subjectUploadModal').style.display === 'flex') {
                app.modal.closeSubjectUpload();
            }
        }
    });

    window.app = app;
    app.auth.init();
</script>
</body>
</html>
